#!/bin/bash
# postinst script for internet-monitor

set -e

# Source debconf library
. /usr/share/debconf/confmodule

case "$1" in
    configure)
        # Create sound directory if it doesn't exist
        if [ ! -d /usr/share/asterisk/sounds/custom ]; then
            mkdir -p /usr/share/asterisk/sounds/custom
        fi
        
        # Download audio files if they don't exist
        SOUND_DIR="/usr/share/asterisk/sounds/custom"
        if [ ! -f "${SOUND_DIR}/internet-yes.ul" ] || [ ! -f "${SOUND_DIR}/internet-no.ul" ]; then
            echo "Downloading audio files..."
            
            # Check for download tool
            if command -v wget >/dev/null 2>&1; then
                DOWNLOAD_CMD="wget -q -O"
            elif command -v curl >/dev/null 2>&1; then
                DOWNLOAD_CMD="curl -sSL -o"
            else
                echo "Warning: Neither wget nor curl found. Audio files will not be downloaded."
                echo "Please install wget or curl, or manually download the audio files."
                exit 0
            fi
            
            # Download audio files
            BASE_URL="https://raw.githubusercontent.com/KD5FMU/Internet-Monitor-ASL3/main"
            cd "$SOUND_DIR"
            
            if $DOWNLOAD_CMD internet-yes.ul "${BASE_URL}/internet-yes.ul"; then
                echo "Downloaded internet-yes.ul"
            else
                echo "Warning: Failed to download internet-yes.ul"
            fi
            
            if $DOWNLOAD_CMD internet-no.ul "${BASE_URL}/internet-no.ul"; then
                echo "Downloaded internet-no.ul"
            else
                echo "Warning: Failed to download internet-no.ul"
            fi
        fi
        
        # Reload systemd daemon
        if command -v systemctl >/dev/null 2>&1; then
            systemctl daemon-reload || true
        fi
        
        # Install default configuration if it doesn't exist
        if [ -f /etc/internet-monitor.conf.dpkg-new ]; then
            if [ ! -f /etc/internet-monitor.conf ]; then
                mv /etc/internet-monitor.conf.dpkg-new /etc/internet-monitor.conf
                echo "Created default configuration file at /etc/internet-monitor.conf"
            else
                rm -f /etc/internet-monitor.conf.dpkg-new
            fi
        fi
        
        # Check if configuration needs to be set up
        if [ ! -f /etc/internet-monitor.conf ] || ! grep -q "^NODE_NUMBER=" /etc/internet-monitor.conf 2>/dev/null || grep -q "^NODE_NUMBER=12345$" /etc/internet-monitor.conf 2>/dev/null; then
            echo ""
            echo "=========================================="
            echo "Internet Monitor Configuration Required"
            echo "=========================================="
            echo ""
            echo "Please edit /etc/internet-monitor.conf and set your NODE_NUMBER"
            echo "Then start the service with:"
            echo "  sudo systemctl start internet-monitor"
            echo "  sudo systemctl enable internet-monitor"
            echo ""
        fi
        ;;
    
    abort-upgrade|abort-remove|abort-deconfigure)
        ;;
    
    *)
        echo "postinst called with unknown argument \`$1'" >&2
        exit 1
        ;;
esac

# dh_installdeb will replace this with shell code automatically
# generated by other debhelper scripts.

#DEBHELPER#

exit 0
